<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>tristangriffiths.net | tristangriffiths.net</title>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<meta name="author" content="">
<link href="/rss" rel="alternate" type="application/rss+xml" title="tristangriffiths.net" />
<meta property="og:type" content="">
<meta property="og:locale" content="en_AU">
<meta property="og:site_name" content="tristangriffiths.net">
<meta property="og:title" content="Windows 10 IoT and Adafruit LPD8806 RGB LED Strip">
<meta property="og:url" content="">

  <meta property="og:description" content="">



  <meta property="article:published_time" content="2015-07-22T00:00:00+10:00">


<link rel="canonical" href="">


<!-- Bootstrap CSS -->
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
<!-- Font Awesome CSS -->
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<!-- Purdy Fonts CSS -->
<link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
<!-- Site -->
<link href="/assets/css/site.min.css" rel="stylesheet" type="text/css">
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="//oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
	<!-- Navigation -->
	<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
		<div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">tristangriffiths.net</a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav navbar-right">
            <li>
                <a href="/">Home</a>
            </li>
            <li>
                <a href="/about">About</a>
            </li>
        </ul>
    </div>
    <!-- /.navbar-collapse -->
</div>
<!-- /.container -->
	</nav>
	
	<!-- Page Header -->
<header class="intro-header" style="background-image: url('/assets/img/lpd8806.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1 id="title">Windows 10 IoT and Adafruit LPD8806 RGB LED Strip</h1>
                    <h2 class="subheading">Glowly, flexible, SPI-addressed LEDs using Windows 10 IoT on Raspberry Pi 2</h2>
                    <span class="meta">Posted on July 22, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article itemscope itemtype="http://schema.org/BlogPosting">
    <meta itemprop="name" content="Windows 10 IoT and Adafruit LPD8806 RGB LED Strip" />
    <meta itemprop="headline" content="Glowly, flexible, SPI-addressed LEDs using Windows 10 IoT on Raspberry Pi 2" />
    <meta itemprop="datepublished" content="July 22, 2015">
    
    <meta itemprop="image" content="/assets/img/lpd8806.jpg" />	
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1" itemprop="articleBody">
                <h3 id="introduction">Introduction</h3>

<p>I got one metre of the <a href="http://www.adafruit.com/product/306" title="DIGITAL RGB LED WEATHERPROOF STRIP - LPD8806 32 LED">Adafruit LPD8806 RGB LED strip</a> with a <a href="http://www.netduino.com/netduinoplus2/" title="Netduino Plus 2">NetDuino Plus 2</a> many years ago with bold visions of colourful Christmas decorations on the front of the house. After some success with blinding myself, they were forgotten about when child #1 arrived. The NetDuino suffered the same fate as it couldn’t talk HTTPS.</p>

<p>When Microsoft announced they would support Windows 10 IoT on the new Raspberry Pi 2, the wheels started turning again.</p>

<p>The code is a shameless hack job of the <a href="http://netduinohelpers.codeplex.com/" title="netduino Helpers">netduino helpers</a> project on CodePlex. I’ve stripped it down to just setting static colours across all of the LED’s. I am not planning any animations yet.</p>

<h3 id="hardware">Hardware</h3>

<ul>
  <li>Raspberry Pi 2 Model B - <a href="http://au.element14.com/raspberry-pi/raspberrypi-2-modb-1gb/sbc-raspberry-pi-2-model-b-1gb/dp/2461030" title="RASPBERRYPI-2-MODB-1GB">Element 14</a>.</li>
  <li>2A Micro-USB power supply - <a href="http://au.element14.com/pro-power/psu-raspberry-pi-2a-5v/psu-raspberry-pi-5v-2a-micro-usb/dp/2444596" title="PSU-RASPBERRY-PI-2A-5V">Element 14</a>.</li>
  <li>Micro SD card for Windows 10 IoT - <a href="http://www.scorptec.com.au/product/Flash_Memory/Micro_SD_Cards/55778-MB-MG32DA_APC" title="Samsung PRO Micro SDHC 32GB SD Card">Scorptec</a></li>
  <li>LPD8806-based RGB LED strip - <a href="http://www.adafruit.com/product/306" title="Digital RGB LED Weatherproof Strip">Adafruit</a></li>
  <li>5V 10A power supply - <a href="http://www.adafruit.com/products/658" title="5V 10A switching power supply">Adafruit</a></li>
  <li>Female DC Power adapter - <a href="http://www.adafruit.com/products/368" title="Female DC Power adapter">Adafruit</a></li>
  <li>Jumper wires</li>
</ul>

<h3 id="wiring">Wiring</h3>

<p>Already had wires soldiered to the LED strip from previous experiments (<a href="https://learn.adafruit.com/digital-led-strip/wiring" title="Digital RGB LED Strip Wiring">Adafruit tutorial</a>), so all I needed was the <a href="https://ms-iot.github.io/content/en-US/win10/samples/PinMappingsRPi2.htm" title="Raspberry Pi 2 Pin Mappings">Raspberry Pi 2 pinout diagram</a> on the <a href="http://go.microsoft.com/fwlink/p/?LinkID=534186" title="Windows IoT Home">Windows IoT site</a>:</p>

<ul>
  <li>Connect the black ground (GND) to any ground PIN of the RPi2 - I used 39.</li>
  <li>Connect the yellow clock (CI) to the SPI0 SCLK (PIN 23) of the RPi2.</li>
  <li>Connect the green data wire (DI) to the SPI0 MOSI (PIN 19) of the RPi2.</li>
  <li>Connect the red +5V power wire to your power supply.</li>
</ul>

<h3 id="initialisation-code">Initialisation Code</h3>

<p>Here is the C# code for the top-level constructor and initialisation function. Have had to move SPI initialisation to its own method so we can handle the async calls.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class AdaFruitLPD8806 : IDisposable
{
    private const int bytesPerPixel = 3;

    private SpiDevice spi;
    private int pixelCount;
    private int frameSize;
    private int pixelBufferEnd;
    private byte[] pixelBuffer;
    private bool disposed = false;

    protected byte[] backgroundColor = new byte[bytesPerPixel];
    protected byte[] attentionSequence = new byte[] { 0, 0, 0, 0 };
    protected byte[] latchSequence = new byte[] { 0, 0, 0 };

    public AdaFruitLPD8806(int width, int height, string spiControllerName = "SPI0", Int32 spiChipSelectLine = 0, int clockFrequency = 10000000)
    {
        this.Width = width;
        this.Height = height;
        this.pixelCount = width * height;
        this.pixelBufferEnd = (pixelCount - 1) * bytesPerPixel;
        this.frameSize = width * height * bytesPerPixel;
        this.SpiControllerName = spiControllerName;
        this.SpiChipSelectLine = spiChipSelectLine;
        this.ClockFrequency = clockFrequency;

        pixelBuffer = new byte[pixelCount * bytesPerPixel];
    }

    private int Width { get; set; }
    private int Height { get; set; }
    private string SpiControllerName { get; set; }
    private Int32 SpiChipSelectLine { get; set; }
    private int ClockFrequency { get; set; }

    public async Task Initialize()
    {
        try
        {
            await InitSpi();
        }
        catch (Exception ex)
        {
            Debug.WriteLine("Exception : {0}", ex);
        }

        pixelBuffer = new byte[pixelCount * bytesPerPixel];
    }
}
</code></pre></div></div>

<ul>
  <li>Set up some variables and constants that describe the RGB LED strip.</li>
  <li>The Raspberry Pi 2 SPI port needs initialisation so we call the InitSpi() method.</li>
  <li>If the initialisation fails we can handle the error.</li>
</ul>

<p>Next, we take a closer look at the SPI initialisation function.</p>

<h4 id="initspi">InitSpi()</h4>

<p>The SPI bus on the Raspberry Pi 2 is used to send a byte array of encoded RGB levels for each of the LEDs on the string and needs to be configured before we can use it.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private async Task InitSpi()
{
    try
    {
        var settings = new SpiConnectionSettings(this.SpiChipSelectLine);           /* Create SPI initialization settings */
        settings.ClockFrequency = this.ClockFrequency;                              /* Datasheet specifies maximum SPI clock frequency of 10MHz */
        settings.Mode = SpiMode.Mode0;                                              /* Not sure. Worked for me */

        string spiAqs = SpiDevice.GetDeviceSelector(this.SpiControllerName);        /* Find the selector string for the SPI bus controller */
        var devicesInfo = await DeviceInformation.FindAllAsync(spiAqs);             /* Find the SPI bus controller device with our selector string */
        this.spi = await SpiDevice.FromIdAsync(devicesInfo[0].Id, settings);        /* Create an SpiDevice with our bus controller and SPI settings */
    }
    catch (Exception ex)
    {
        Debug.WriteLine("Exception : {0}", ex);
        throw new InvalidOperationException("SPI Initialization Failed", ex);
    }
}
</code></pre></div></div>

<ul>
  <li>Start by specifying some SPI configuration settings that I don’t fully understand. 10MHz sounds good right?</li>
  <li>More device discovery.</li>
  <li>Create the SpiDevice using the settings and bus controller.</li>
</ul>

<h3 id="all-the-colours">All The Colours</h3>

<p>Now that the SPI device is initialised, we can send some bytes to our LED strip. We only need two functions to do most of the work.</p>

<h4 id="setcolor">SetColor()</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Sets the color of the entire strip
public void SetColor(byte red, byte green, byte blue)
{
    SetBackgroundColor(redGamma[red], greenGamma[green], blueGamma[blue]);
    for (var pixel = 0; pixel &lt; frameSize; pixel += bytesPerPixel)
    {
        Array.Copy(backgroundColor, 0, pixelBuffer, pixel, bytesPerPixel);
    }
}
</code></pre></div></div>

<ul>
  <li>We first set up our “Background” array with each of our 8-bit colour values. We use the gamma dictionary lookup (RedGamma, GreenGamma, BlueGamma) so the colours look “correct” and to convert the 8-bit colour in to the 7-bit colour supported by the LPD8806 chip.</li>
  <li>Next, we copy the background colour array over to our pixel buffer that will be written to SPI in the Refresh() method.</li>
</ul>

<h4 id="refresh">Refresh()</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Send the internal pixel buffer to the strip
public void Refresh()
{
    if (spi == null)
        return;

    spi.Write(attentionSequence);
    spi.Write(pixelBuffer);
    var ledLatchCount = pixelCount * 2;
    for (var i = 0; i &lt; ledLatchCount; i++)
    {
        spi.Write(latchSequence);
    }
}
</code></pre></div></div>

<ul>
  <li>No spi means we have not yet called Initialize</li>
  <li>Adafruit LPD8806 strip requires a set of “attention” bytes before writing out our pixel buffer.</li>
  <li>Write our pixel buffer.</li>
  <li>Latch written bytes by sending zeros to each pixel (* 2).</li>
</ul>

<h3 id="pretty">Pretty</h3>

<p>Took a flash photo and forgot about the Raspberry Pi 2’s kryptonite. Windows IoT failed hard. Need to get a Pi case.</p>

<p><img src="/assets/img/lpd8806-pi.jpg" alt="Raspberry Pi2 LPD8806" /></p>

<p>A basic XAML GUI with Caliburn.Micro and Autofac.</p>

<p><img src="/assets/img/lpd8806-ui.jpg" alt="Windows IoT" /></p>

<h3 id="download">Download</h3>

<p>My <a href="/assets/misc/adafruitlpd8806.zip" title="AdaFruitLPD8806.zip">scrappy LPD8806 class</a>.</p>

            </div>
        </div>
    </div>
</article>

	<!-- Footer -->
	<footer>
		<div class="container">
	<div class="row">
		<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
			<ul class="list-inline text-center">
				<li>
					<a href="https://au.linkedin.com/in/trgriffiths">
						<span class="fa-stack fa-lg">
							<i class="fa fa-circle fa-stack-2x"></i>
							<i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
						</span>
					</a>
				</li>
				<li>
					<a href="/rss">
						<span class="fa-stack fa-lg">
							<i class="fa fa-circle fa-stack-2x"></i>
							<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
						</span>
					</a>
				</li>
			</ul>
			<p class="copyright text-muted">Tristan Griffiths &copy; Copyright 2019. All Rights Reserved.</p>
		</div>
	</div>
</div>
	</footer>
	
	<!-- jQuery JS -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap JS -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Site -->
<script src="/assets/js/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65313416-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>